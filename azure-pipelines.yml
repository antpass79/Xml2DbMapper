# Standard CI build - which build, test and publish artifact

pool:
  name: Xml2DbWrapper Build Pipeline
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'
  azureDevOpsProjectName: Xml2DbMapper
  feedName: Xml2DbMapper

steps:
- task: UseGitVersion@5
  displayName: 'Git Version updates AssemblyInfo for Xml2DbWrapper.Core'
  inputs:
    versionSpec: '5.x'
    updateAssemblyInfo: true
    updateAssemblyInfoFilename: '$(system.defaultworkingdirectory)\Xml2DbWrapper.Core\Properties\AssemblyInfo.cs'
- task: UseGitVersion@5
  displayName: 'Git Version updates AssemblyInfo for Xml2DbWrapper.Reader'
  inputs:
    versionSpec: '5.x'
    updateAssemblyInfo: true
    updateAssemblyInfoFilename: '$(system.defaultworkingdirectory)\Xml2DbWrapper.Reader\Properties\AssemblyInfo.cs'
- task: UseGitVersion@5
  displayName: 'Git Version updates AssemblyInfo for Xml2DbWrapper.Writer'
  inputs:
    versionSpec: '5.x'
    updateAssemblyInfo: true
    updateAssemblyInfoFilename: '$(system.defaultworkingdirectory)\Xml2DbWrapper.Reader\Properties\AssemblyInfo.cs'

# Build Solution
- task: DotNetCoreCLI@2
  displayName: Restore packages
  inputs:
    command: restore
    projects: '**/*.sln'
    versioningScheme: byBuildNumber
- task: DotNetCoreCLI@2
  displayName: 'Build Xml2DbWrapper Solution'
  inputs:
    command: 'build'
    arguments: '--configuration $(BuildConfiguration) /p:Version=$(GitVersion.NuGetVersion)'
    projects: Xml2DbWrapper.sln
    versioningScheme: byBuildNumber

# Publish Artifacts
- task: DotNetCoreCLI@2
  displayName: 'Pack Xml2DbWrapper.Core'
  inputs:
    command: 'pack'
    arguments: --output $(build.artifactstagingdirectory) --configuration $(buildConfiguration)
    packagesToPack: 'Xml2DbWrapper.Core/Xml2DbWrapper.Core.csproj'
    versioningScheme: byEnvVar
    versionEnvVar: GitVersion.NuGetVersion
- task: DotNetCoreCLI@2
  displayName: 'Pack Xml2DbWrapper.Reader'
  inputs:
    command: 'pack'
    arguments: --output $(build.artifactstagingdirectory) --configuration $(buildConfiguration)
    packagesToPack: 'Xml2DbWrapper.Reader/Xml2DbWrapper.Reader.csproj'
    versioningScheme: byEnvVar
    versionEnvVar: GitVersion.NuGetVersion
- task: DotNetCoreCLI@2
  displayName: 'Pack Xml2DbWrapper.Writer'
  inputs:
    command: 'pack'
    arguments: --output $(build.artifactstagingdirectory) --configuration $(buildConfiguration)
    packagesToPack: 'Xml2DbWrapper.Writer/Xml2DbWrapper.Writer.csproj'
    versioningScheme: byEnvVar
    versionEnvVar: GitVersion.NuGetVersion
- task: DotNetCoreCLI@2
  displayName: 'Push artifacts in $(azureDevOpsProjectName)/$(feedName) feed'
  inputs:
    command: 'push'
    nuGetFeedType: 'internal'
    packagesToPush: '$(build.artifactStagingDirectory)/*.nupkg'
    publishVstsFeed: '$(azureDevOpsProjectName)/$(feedName)'
    versioningScheme: byBuildNumber