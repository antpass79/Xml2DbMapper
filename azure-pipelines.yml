# Build Pipeline - which build, test and publish artifact

pool:
  vmImage: 'windows-latest'

variables:
  buildConfiguration: 'Release'
  azureDevOpsProjectName: 'Xml2DbMapper'
  feedName: 'Xml2DbMapper'

steps:
- task: Bash@3
  inputs:
    targetType: 'inline'
    script: |
      echo 'git config'
      
      git config --global user.email ""
      git config --global user.name ""
      
      echo 'git loop all branches'
      
      git branch -r | grep -v '\->' | while read remote; do git branch --track "${remote#origin/}" "$remote"; done
      
      echo 'git push all branches'
      
      git push https://$xml2dbtoken@dev.azure.com/antpass79/Xml2DbMapper/_git/Xml2DbMapper -u --all
- task: UseGitVersion@5
  displayName: 'Git Version updates SharedAssemblyInfo for Xml2DbMapper'
  inputs:
    versionSpec: '5.x'
    updateAssemblyInfo: true
    updateAssemblyInfoFilename: '$(system.defaultworkingdirectory)\SharedAssemblyInfo.cs'

- task: DotNetCoreCLI@2
  displayName: Restore packages
  inputs:
    command: restore
    projects: '**/*.sln'
    versioningScheme: byBuildNumber
- task: DotNetCoreCLI@2
  displayName: 'Build Xml2DbMapper Solution'
  inputs:
    command: 'build'
    arguments: '--configuration $(BuildConfiguration) /p:Version=$(GitVersion.NuGetVersion)'
    projects: Xml2DbMapper.sln
    versioningScheme: byBuildNumber

- task: DotNetCoreCLI@2
  displayName: 'Pack Xml2DbMapper'
  inputs:
    command: 'pack'
    arguments: --output $(build.artifactstagingdirectory) --configuration $(buildConfiguration)
    packagesToPack: 'Xml2DbMapper.sln'
    versioningScheme: byEnvVar
    versionEnvVar: GitVersion.NuGetVersion
- task: DotNetCoreCLI@2
  displayName: 'Push artifacts in $(azureDevOpsProjectName)/$(feedName) feed'
  inputs:
    command: 'push'
    nuGetFeedType: 'internal'
    packagesToPush: '$(build.artifactStagingDirectory)/*.nupkg'
    publishVstsFeed: '$(azureDevOpsProjectName)/$(feedName)'
    versioningScheme: byBuildNumber